---
layout:     post
title:      "简单动态字符串"
subtitle:   " \"redis设计与实现\""
date:       2021-09-21 12:00:00
author:     "Zm"
header-img: "img/post-bg-2020.jpg"
tags:
    - redis



---



# 简单动态字符串

Redis没有直接使用C语言传统的字符串表示，而是自己创建了一种名为简单动态字符串（simple dynamic string，SDS）的抽象类型。并将SDS用作Redis的默认字符串表示。

除了用来保存数据库中的字符串值之外，SDS还被用作缓冲区（buffer）；AOF模块中的AOF缓冲区，以及客户端状态中的输入缓冲区，都是SDS实现的。

## SDS的定义

每个sds.h/sdshdr结构表示一个SDS值：

```c
struct sdshdr{
	//保存buf数组中已使用字节数量
	int len;
	//保存buf数组中尚未使用的字节数量
	int free;
	//字节数组，用于保存字符串
	char buf[];
}
```

SDS遵循C字符串以空字符结尾的惯例，保存空字符的1字节空间不计算在SDS的len属性中，并且为空字符额外分配1字节空间。**以空字符结尾的好处是，可以直接复用一部分C字符串函数库中的函数。**

## SDS与C字符串的区别

### 以常数时间复杂度获取字符串长度

C字符串并不记录自身的长度信息，所以获取一个C字符串长度，必须要遍历整个字符串，直到遇到代表字符串结尾的空字符串为止。整个操作的时间复杂度是O(n)。

而SDS将这一信息保存在len属性中，并且设置和更新SDS的操作由SDS的API执行时自动完成的，无需手动实现。

### 杜绝缓冲区溢出

C字符串不记录自身长度的另一个问题是容易导致缓冲区溢出，当字符串进行拼接操作时，如果拼接后的字符串超出原先分配的内存就会导致缓冲区溢出。

而SDS的空间分配策略杜绝了这一问题的发生。当SDS的API进行修改时，会先检查分配的内存空间是否满足修改的需求，如果不满足，API将会自动将SDS的空间扩展至执行修改所需空间，然后才执行实际的操作。

### 减少修改字符串时带来的内存重分配次数

因为C字符串并不记录自身的长度，所以对于一个包含N个字符的字符串来说，底层总是实现一个N+1个字符长的数组。**每次增长或缩短一个C字符串，程序总要对保存这个C字符串的数组进行一次内存重分配**。

因为内存重分配涉及复杂的算法，可能需要执行系统调用，通常是一个比较耗时的操作。

为了避免C字符串的这种缺陷，SDS使用free属性记录未使用空间，解除了字符串长度和底层数组长度之间的关联。

通过未使用空间，SDS实现了空间预分配和惰性空间释放两种优化策略。

1. 空间预分配

    针对字符串增长的场景，如果原空间不足，程序不仅为SDS分配所需空间，还会额外分配未使用空间。如果增长后的字符串所需空间小于1MB，则会分配一倍的未使用空间，如果大于1MB，则会直接分配1MB的未使用空间。

2. 惰性空间释放

    当字符串缩短的场景下，程序不会立即回收内存空间，而是会等待一段时间再回收，这是为了减少频繁的分配空间，提高空间的重复利用率。

### 二进制安全

C字符串中的字符必须符合某种编码（如ASCII），并且除了字符串末尾外，不能包含空字符。这些限制使得C字符串只能保存文本数据，而不能保存像图片、音频、视频、压缩文件这样的二进制数据。

**SDS使用len属性的值，而不是空字符来判断字符串是否结束的。**

### 兼容部分C字符串函数

由于SDS遵循以空字符结尾的方式，在一定程度上，可以让那些保存文本数据的SDS能重用一部分`<string.h>`库定义的函数。

## 总结

| C字符串                           | SDS                                    |
| --------------------------------- | -------------------------------------- |
| 获取字符串长度时间复杂度O(n)      | 获取字符串长度**时间复杂度O(1)**       |
| API是不安全的，可能导致内存区溢出 | API是**安全**的，不会导致内存区溢出    |
| 修改字符串长度必然导致内存重分配  | 修改字符串长度**不一定**导致内存重分配 |
| 只能保存文本数据                  | 可以保存文本和**二进制数据**           |
| 可以使用所有<string.h>函数        | 可以使用**一部分**<string.h>函数       |

