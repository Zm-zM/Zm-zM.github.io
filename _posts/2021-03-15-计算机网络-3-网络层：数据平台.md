---
layout:     post
title:      "计算机网络-网络层：数据平台"
subtitle:   " \"基础内容\""
date:       2021-03-15 12:00:00
author:     "Zm"
header-img: "img/post-bg-2020.jpg"
tags:
    - 计算机网络
---

# 网络层：数据平台

我们将网络层分解为两个互相作用的部分，即数据平面和控制平面。在数据平面，决定到达路由器输入链路之一的数据报如何转发到该路由器的数据链路之一，将涉及IP转发和通用的转发。在控制平面，控制数据报沿着从源主机到目的主机的端到端路径中路由器之间的路由方式，主要涉及的是路由选择算法。

## 网络层概述

### 转发和路由选择：数据平面和控制平面

网络层的作用从表面上看极为简单，即将一个分组从一台发送主机移动到一台接收主机，为此，需要使用两种重要的网络层功能。

- 转发。当一个分组达到某路由器的一条输入链路时，该路由器必须将该分组移动到适当的输出链路。
- 路由选择。当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。计算这些路径的算法被称为路由选择算法。

**转发是指将分组从一个输入链路接口转移到适当的输出链路接口的路由器本地动作。**转发发生的时间尺度很短，因而通常用硬件来实现。路由选择是指确定分组从源到目的地所采取的端到端路径的网络范围处理过程。路由选择发生的时间尺度长得多，因而通常用软件来实现。

## 路由器工作原理

下图显示了一个通用路由器体系结构的总体视图

<img src="E:\Java笔记\image\image-20200606135416931.png" alt="image-20200606135416931" style="zoom: 33%;" />

-  输入端口，输入端口执行几项重要功能。它在路由器中执行**终结入物理链路的物理层功能**，它还要与位于入链路远端的数据链路层交互来**执行数据链路层功能**。最后，在输入端口还要执行**查找功能**，在这里，通过查询转发表决定路由器的输出端口，到达的分组通过路由器的交换结构转发到输出端口。
-  交换结构，交换结构将路由器的输入端口连接到它的输出端口，这种交换结构包含在路由器之中，即它是网络路由器中的一个网络。
-  输出端口，输出端口存储从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组。
-  路由选择处理器，路由选择处理器执行控制平面功能。在传统的路由器中，路由选择处理器执行路由选择协议，维护路由选择表与关联链路状态信息，并为该路由器计算转发表。在SDN路由器中，路由选择处理器负责与远程控制器通信，目的是接收有远程控制器计算的转发表项，并在该路由器的输入端口安装这些表项。

路由器的输入端口、输出端口和交换结构几乎总是用硬件实现的，因为使用硬件设计的处理速度往往比软件要快得多。而数据报处理流水线的速度要求比控制平面要高得多。

### 输入端口处理和基于目的地转发

输入端口的线路端接功能与链路层处理实现了用于各个输入链路的物理层和链路层。在输入端口中执行的查找对于路由器运行是至关重要的。正是在这个地方，路由器使用转发表来查找输出端口，使得到达的分组能经过交换结构转发到该输出端口。 

在32比特IP地址的情况下，假设我们的路由器具有4条链路，分组使用前缀匹配来转发到对应的端口。

|           前缀匹配           | 链路接口 |
| :--------------------------: | :------: |
|   11001000 00010111 00010    |    0     |
| 110010000 000010111 00011000 |    1     |
|  110010000 000010111 00011   |    2     |
|             其他             |    3     |

当有多个匹配时，该路由器使用最长前缀匹配规则，在表中寻找最长前缀匹配规则，并向与最长前缀匹配相关联的链路接口转发分组。

一旦通过查找确定了某分组的输出端口，则该分组就能够发送进入交换结构。在某些设计中，如果来自其他输入端口的分组当前正在使用该交换结构，一个分组可能会在进入该交换结构时被暂时阻塞。

### 交换

交换结构位于一台路由器的核心部位，因为正是通过这种交换结构，分组才能实际地从一个输入端口交换到一个输出端口。交换可以用很多种方式完成，如下图所示：

<img src="E:\Java笔记\image\image-20200606145711695.png" alt="image-20200606145711695" style="zoom: 33%;" />

- 经内存交换。最简单、最早地路由器是传统的计算机，在输入端口与输出端口之间的交换是在CPU（路由选择处理器）的直接控制下完成的。不能同时转发两个分组，即使它们有不同的目的和端口，因为经过共享系统总线一次仅能执行一个内存读/写。
    许多现代路由器通过内存进行交换，然而和早期路由器的主要区别是，目的地址的查找和将分组存储（交换）进适当的内存存储位置是由输入线路卡来处理的。
- 经总线交换。在这种方法中，输入端口经一根共享总线将分组直接传送到输入端口，不需要路由选择处理器的干预。分组在传输前，会预先计划一个交换机内部标签，指示输出端口，该分组能被所有输出端口收到，但只有与该标签匹配的端口才能保存该分组。然后标签在输出端口被去除。如果多个分组同时到达路由器，每个位于不同的输出端口，除了一个分组外，其他分组都必须等待，因为一次只有一个分组能够跨越总线。
- 经互联网络交换。克服单一、共享式总线带宽限制的一种方法是，使用一个更复杂的互联网络。与前两中方法不同的是，纵横式网络能够并行转发多个分组。纵横式交换机是非阻塞的，即只要没有其他分组被转发到当前输出端口，转发到输出端口的分组将不会被到达其他输出端口的分组阻塞。

### 分组调度

现在我们开始讨论确定次序的问题，即排队的分组如何经输入链路传输的问题。

> 先进先出

FIFO（也称先来先服务，FCFS）调度规则按照分组达到输出链路队列的相同次序来选择分组在链路中传输。

> 优先权排队

在优先权排队的规则下，到达输出链路的分组被分类放入输出队列中的优先权类。每个优先权类通常都有自己的队列。当选择一个分组传输时，优先权规则将从队列非空的最高优先权类中传输一个分组。

<img src="E:\Java笔记\image\image-20200606152555956.png" alt="image-20200606152555956" style="zoom: 50%;" />

> 循环和加权公平排队

在循环排队规则下，分组像使用优先权排队那样被分类。然而在类之间不存在严格的服务优先权。循环调度器在这些类之间轮流提供服务。

一种通用形式的循环排队已经广泛地实现在路由器中，它就是所谓地加权平均排队规则（WFQ）。与循环排队规则不同之处在于，每个类在任何时间间隔内可能收到不同数量的服务。

## 网际协议：IPv4、寻址、IPv6及其他

### IPv4数据报格式

网络层分组被称为数据报。IPv4数据报格式如下图所示：

<img src="E:\Java笔记\image\image-20200606153125749.png" alt="image-20200606153125749" style="zoom: 50%;" />

- 版本号：这4比特规定了数据报的IP协议版本。
- 首部长度：因为数据报中通常存在可变长的选项，故需要这4比特来确定IP数据报中载荷实际开始的地方。
- 服务类型。服务类型（TOS）比特包含在IPv4首部中，以便使不同类型的IP数据报能相互区别开
- 数据报长度。这时IP数据报的总长度（首部+数据），以字节为单位。
- 标识、标志、片漂移。这三个字段和IP分片有关，但IPv6中，不允许对数据报进行分片。
- 寿命。寿命（TTL）字段用来确保数据报不会永远在网络中循环
- 协议。该字段通常仅当一个IP数据报到达其最终目的地时才会有用。该字段指示了IP数据报的数据部分该交给哪个特定的运输层协议。
- 首部检验和。首部检验和用于帮助路由器检测收到的IP数据报中的比特错误。
- 源和目的IP地址。当某源生成一个数据报时，它在源IP字段中插入它的IP地址，在目的IP地址字段中插入其最终目的地的地址。
- 选项。选项字段允许IP首部被扩展。
- 数据。

### IPv4数据报分片

并不是所有链路层协议都能承载相同长度的网络层分组。一个链路层帧能承载的最大数据量叫作最大传送单元（MTU）。MTU严格控制着IP数据报的长度，但发送方与目的地路径上的每段链路可能使用不同的链路层协议，且每种协议可能具有不同的MTU。

解决该问题的方法是，将IP数据报中的数据分片成两个或多个的IP数据报，每个较小的数据报都称为片。片在其达到目的地运输层以前需要重新组装，而重新组装的工作被放在了端系统中。

当一台主机从相同的源收到一系列数据时，它需要确定这些数据报是否是片。如果某些数据被分成了片，它就要确认是否收到了最后一片，并且任何将这些接收到的片连接在一起以形成初始的数据报。为了让主机执行这些任务，IPv4的设计者将标识、标志和片偏移字段放在IP数据报首部中。标识用来标识数据报的位置。而标志用来确认是否为最后一片，最后一片的标志被设置为1，而其他被设置为0。片偏移用来确定该片应当放在初始IP数据报中的哪个位置。 

### IPv4编址

每个IP地址长度为32比特，这些地址通常按所谓点分十进制记法书写，及每个地址中的每个字节用它的十进制形式进行书写，各字节间以句号隔开（如255.255.255.255）。在全球因特网中的每台主机和路由器上的每个接口，都必须有一个全球唯一的IP地址。然而，这些地址不能随意地自由选择。一个接口的IP地址的一部分需要由其连接的子网来决定。

<img src="E:\Java笔记\image\image-20200606164211990.png" alt="image-20200606164211990" style="zoom:50%;" />

上图中，三个主机接口与一个路由器接口形成一个子网，IP编址为这个子网分配一个地址223.1.1.0/24，其中的/24记法，有时称为**子网掩码**，指示32比特中的最左侧24比特定义了子网地址。

​	因特网的地址分配策略被称为**无类别域间路由选择**。当使用子网寻址时，32比特的IP地址被划分为两部分，并且也具有点分十进制形式`a.b.c.d/x`，其中x指示了地址的第一部分中的比特数。

形式为`a.b.c.d/x`的地址的x最高比特构成了IP地址的网络部分，并且经常被称为该地址的前缀。

### 获取主机地址：动态主机配置协议

某组织一旦获得了一块地址，它就可为本组织内的主机与路由器接口逐个分配IP地址。这项任务更多使用哦个动态主机配置协议（DHCP）来完成。DHCP允许主机自动获取一个IP地址，配置DHCP使其给某固定主机每次在网络连接是分配相同的IP地址，或者某主机被分配一个临时的IP地址。

### IPv6数据报格式

由于新的子网和IP节点以惊人的增长率连到了因特网上，32比特的IP地址空间即将用尽。为了应对这种对大IP地址空间的需求，开发了一种新的IP协议，即IPv6。

<img src="E:\Java笔记\image\image-20200606170741755.png" alt="image-20200606170741755" style="zoom: 50%;" />

- 版本。用于标识IP版本号。
- 流量类型，与IPv4中类似
- 流标签。该20比特的字段用于标识一条数据报的流，能够为一条流中的某些数据报给出优先权。
- 有效载荷长度。该16比特值作为一个无符号整数，给出了IPv6数据报中跟在定长的40字节数据报首部后面的字节数量。
- 下一个首部。该字段标识数据报中的内容需要交付给哪个协议（如TCP或UDP）。
- 跳限制。转发数据报的每台路由器将对该字段的内容减1，如果跳限制计数达到0，则该数据报将被丢弃。
- 源地址和目的地址。
- 数据。这时IPv6数据报的有效载荷部分。

## 通用转发和SDN

在通用转发中，一张匹配加动作表将我们之前看到的基于目的地的转发表一般化了。因为能够使用网络层和/或链路层源和目的地做出转发决定。

下图显示了位于每台分组交换机中的一张匹配加动作表，该表由远程控制器计算、安装和更新。

<img src="E:\Java笔记\image\image-20200607100713556.png" alt="image-20200607100713556" style="zoom: 33%;" />

匹配加动作表在OpenFlow中称为流表（flow table），它的每个表项包括：

- 首部字段表的集合，入分组将与之匹配。
- 计数器集合，这些计数器可以包括已经与该表项匹配的分组数量，以及自从该表项上次更新以来的时间。
- 当分组匹配流表项时所采用的动作集合，这些动作可以将分组转发到给定的输入端口，丢弃该分组、复制该分组和将它们发送到多个端口，和/或重写所选的首部字段。