---
layout:     post
title:      "MySQL-创建高性能索引"
subtitle:   " \"基础内容\""
date:       2021-03-15 12:00:00
author:     "Zm"
header-img: "img/post-bg-2020.jpg"
tags:
    - MySQL
---

# 高性能索引

索引（在MySQL中也叫做"KEY"）是存储引擎用于快速找到数据的一种数据结构。

## 索引的种类

### B-Tree索引

B-Tree意味着所有值都是按顺序存储的，而且每一个叶子页到根的距离相同。因此B-Tree索引很适合用来查找范围数据。但需要注意的是，索引对多个值进行排序的依据是CREATE TABLE语句中定义索引时列的顺序。

B-Tree索引适用于**全键值、键值范围或键前缀查找**。其中键前缀只适用于根据**最左前缀**的查找。

### 哈希索引

哈希索引基于哈希表实现，只有**精确匹配索引所有列**的查询才有效。

因为哈希索引自身只需存储对应的哈希值，所以索引的结构十分紧凑，这也让哈希索引查找非常快，但还是有一些限制：

1. 哈希索引只包含哈希值和行指针，而不存储字段值，所以不能使用索引中的值避免行读取。
2. 哈希索引数据并不是按照索引值顺序存储的，因此不支持排序。
3. 哈希索引不支持部分索引列匹配查找，因为哈希值始终是基于索引列的全部内容来计算哈希值的。
4. 哈希索引只支持等值索引。
5. 访问哈希索引的速度非常快，但也可能出现哈希冲突问题。如果哈希冲突问题出现很多，索引维护操作的代价将会很高。

InnoDB引擎有一个`自适应哈希索引`的功能，当InnoDB注意到某些索引值被用得十分频繁时，它会在内存中基于B-Tree索引之上再建立一个哈希索引。

**TIPS，创建自定义哈希索引**

如果存储引擎不支持哈希索引，可以模拟像InnoDB一样创建哈希索引。

用CRC32函数模拟生成哈希值，在查询中添加url_crc伪哈希索引列。

```mysql
SELECT id FROM url WHERE url = "www.mysql.com";
SELECT id FROM url WHERE url = "www.mysql.com" AND url_crc = CRC32("www.mysql.com");
```

### 其他索引

空间数据索引

全文索引

......

------

索引可以让服务器快速定位到表的指定位置，但索引的**优点**并不止步于此。

1. 索引大大减少了服务器需要扫描的数据量。
2. 索引可以帮助服务器避免排序和临时表。
3. 索引可以将随机I/O变为顺序I/O。

## 创建高性能索引

**独立的列**才可以使用索引。

**前缀索引和索引选择性**，针对数据较长的行。

**选择合适的索引列顺序**，经验法则将选择性高的列放在索引最前列，但更要考虑避免排序和随机I/O的问题。

### 聚簇索引

聚簇索引并不是一种单独的索引类型，而是一种数据存储方式。具体细节依赖于其具体实现方式。但InnoDB的聚簇索引实际上在同一个结构中保存了B-Tree索引和数据行。**一个表只能有一个聚簇索引。**

<img src="D:\study\学习笔记\Java笔记\image\image-20200728090721069.png" alt="image-20200728090721069" style="zoom: 40%;" />

InnoDB通过主键聚集数据，如果没有定义主键，InnoDB会使用一个唯一的非空索引代替。如果没有这样的索引，InnoDB会隐式定义一个主键来作为聚簇索引。聚簇主键 可能对性能有帮助，但也可能带来严重的性能问题。

聚集数据有以下优点：

1. 可以将相关数据保存在一起，例如实现电子邮箱时，只需要从磁盘读取少量数据页就能获取用户的所有数据，如果没有使用聚簇索引，则每封邮件可能就会导致一次磁盘I/O。
2. 数据访问更快。
3. 使用覆盖索引扫描的查询可以直接使用页节点中的主键值。

但聚簇索引也有一些缺点：

1. 聚簇索引极大提高了I/O密集型应用的性能，但如果数据全部放在内存中，则访问的顺序就没那么重要了。
2. 插入速度严重依赖于插入顺序。
3. 更新聚簇索引的代价很高，聚簇索引会强制将每个被更新的行移动到新的位置。
4. 基于聚簇索引的表插入新行，或者移动更新的行时，可能面临“页分裂”问题。页分裂会导致表占用更多的磁盘空间。
5. 聚簇索引可能会导致全表扫描变慢，特别是行比较稀疏，或者是由于页分裂导致数据存储不连续时。
6. 二级索引（非聚簇索引）可能比想象中的要大，因为包含了主键列。
7. 二级索引访问需要二次索引查找，而不是一次。这是因为二级索引叶子节点中，存储的行指针指向的是行的主键值，而不是行的物理位置。

### 覆盖索引

如果一个索引包含（或者说覆盖）所有需要查询字段的值，我们就称之为覆盖索引。

覆盖索引的好处：

1. 索引条目通常远小于数据行大小，所以如果只需要读取索引，那MySQL就会极大地减少数据访问量。
2. 对于I/O密集型的范围查询会比随机从磁盘读取每一行数据的I/O要少得多。
3. 避免系统调用。
4. 避免对主键索引的二次查询。