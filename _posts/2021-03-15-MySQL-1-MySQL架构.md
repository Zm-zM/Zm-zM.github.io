---
layout:     post
title:      "MySQL-MySQL架构"
subtitle:   " \"基础内容\""
date:       2021-03-15 12:00:00
author:     "Zm"
header-img: "img/post-bg-2020.jpg"
tags:
    - MySQL
---

# MySQL架构

## InnoDB

InnoDB是MySQL的默认事务性引擎，也是最重要、最广泛的引擎。InnoDB的**性能**和**自动崩溃恢复特性**，使得它在非事务型存储的需求中也很流行。

InnoDB采用**MVCC**（Multi-Version Concurrency Control，多版本并发控制）来支持高并发，并且实现了四个标准的隔离级别。其默认隔离级别是REPEATABLE（可重复读），并且通过**间隙锁**策略防止幻读的出现。间隙锁使得InnoDB不仅仅锁定查询涉及的行，还会对索引中的间隙进行锁定，以防止幻影行的插入。

InnoDB表是基于**聚簇索引**建立的。InnoDB的索引结构和MySQL的其他存储引擎有很大的不同，聚簇索引对主键查询有很高的性能。不过它的二级索引中必须包含主键索引，**所以如果主键索引很大，其他的所有索引都会很大。**

InnoDB的存储格式是**平台独立的**，也就是说可以将数据和索引文件在不同的系统上使用。

作为事务型的存储引擎，InnoDB通过一些机制和工具支持**真正的热备份**。MySQL的其他存储引擎不支持热备份，要获取一致性视图需要停止对所有表的写入，而在读写混合场景中，停止写入可能也意味着停止读取。

## MyISAM

在MySQL5.1及之前的版本，MyISAM是默认的存储引擎。MyISAM提供了大量的特性，包括**全文索引、压缩、空间函数（GIS）**等，但MyISAM不支持事务和行级锁，而且有一个毫无疑问的缺陷就是**崩溃后无法安全恢复**。但对于只读的数据，或者表比较小，可以忍受修复操作，则依然可以使用MyISAM。

MyISAM会将表存储在两个文件中：数据文件和索引文件，分别以***.MYD***和***.MYI***为扩展名。

### MyISAM特性

#### 加锁与并发

MyISAM对整张表加锁，而不是针对行。读取时会对需要读到的所有表加共享锁，写入时则对表加排他锁。但是在表有读取查询的时候，也可以往表中插入新的记录。

#### 修复

对于MyISAM表，MySQL可以手工或者自动执行检查和修复操作，但修复操作和事务恢复或崩溃恢复是不同的概念。执行表的恢复可能导致一些数据的丢失，而且修复操作是非常慢的。

#### 索引特性

对于MyISAM表，即使是BLOB和TEXT等长字段，也可以基于其前500个字符创建索引。MyISAM也支持全文索引。

#### 延迟更新索引键

创建MyISAM表的时候，如果指定了DELAY_KEY_WRITE选项，在每次修改执行完成时，不会立刻将修改的索引数据写入磁盘，而是会写到内存中的键缓冲区，只有在清理键缓冲区或者关闭表的时候才会将对于的索引块写入到磁盘。**这种方式可以极大地提升写入性能，但是在数据库或者主机崩溃时会造成索引损坏，需要执行修复操作。**



### MyISAM压缩表

如果表在创建并导入数据后，不会再进行修改操作，那么这样的表或许适合采用MyISAM压缩表。

使用`myisampack`对MyISAM表进行压缩。压缩表是不能进行修改的（除非进行解压）。压缩表可以大大减少磁盘的空间占用，因此也能**减少磁盘I/O**，从而提升查询性能。压缩表也支持索引，但索引也是只读。

## MySQL内建的其他存储引擎

### Archive

Archive存储引擎只支持INSERT和SELECT操作。Archive引擎会缓存所有的写并利用zlib对插入的行进行压缩，所以比MyISAM表的磁盘I/O更少。但是每次SELECT查询都需要执行全表扫描，适合日志和数据采集类应用。

### CSV

CSV引擎可以将普通的CSV文件作为MySQL的表来处理，但是这种表不支持索引。CSV引擎可以在数据库运行期间拷入或拷出文件。可以将EXCEL等电子软件中的数据存储为CSV文件，然后复制到MySQL数据目录下，就能在MySQL中打开使用。同样，如果将数据写入CSV引擎表，其他的外部程序能够立即从表的数据文件中读取CSV格式的数据，因此CSV引擎可以作为一个数据交换的机制。

### Memory

如果需要快速地访问数据，并且这些数据不会被修改，重启后丢失也没有关系，那么使用Memory表是非常合适的。Memory表至少比MyISAM表快一个数量级，因为所有的数据都保存在内存中，不需要进行磁盘I/O。

Memory表是表级锁，因此并发写入的性能较低。它不支持BLOB或者TEXT类型的列，并且每行的长度都是固定的。这可能会导致部分内存的浪费。

## 选择合适的存储引擎

如果应用需要不同的存储引擎，可以从以下几种因素考虑：

- 事务
- 备份
- 崩溃恢复
- 特有的特性